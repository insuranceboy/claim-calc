import streamlit as st

# 🔧 공제 계산 함수 (1세대 오류 방지용 추가 분기)
def 공제계산(금액, 규칙):
    if isinstance(규칙, int) or isinstance(규칙, float):
        공제값 = 규칙
        공제퍼센트 = round((공제값 / 금액 * 100), 1) if 금액 > 0 else 0
        return 공제값, 공제퍼센트
    기준, 퍼센트 = 규칙.replace('max(', '').replace('%)', '').split(',')
    공제값 = max(int(기준), 금액 * (float(퍼센트) / 100))
    공제퍼센트 = round((공제값 / 금액 * 100), 1) if 금액 > 0 else 0
    return 공제값, 공제퍼센트

# 💰 실손 계산기
def 실손_계산기(세대, 병원급, 급여, 급여진료분류, 일반비급여, 도수, 주사, mri, 면책여부):
    병원공제 = {"의원": 10000, "병원": 15000, "상급종합": 20000}
    정액공제 = 병원공제.get(병원급, 15000)

    if 세대 == "4세대":
        급여공제 = max(정액공제, 급여 * 0.2)
        일반비공제 = 'max(30000,30%)'
        특약비공제 = 'max(30000,30%)'
    elif 세대 == "3세대":
        급여공제 = max(정액공제, 급여 * 0.1)
        일반비공제 = 'max(30000,20%)'
        특약비공제 = 'max(30000,30%)'
    elif 세대 == "2세대":
        급여공제 = max(정액공제, 급여 * 0.1)
        일반비공제 = 'max(30000,10%)'
        특약비공제 = 'max(30000,10%)'
    else:
        급여공제 = 0
        일반비공제 = 0
        특약비공제 = 0

    설명목록 = []

    # ✅ 급여 계산
    if 세대 == "1세대":
        급여보상 = max(0, 급여 - 5000) if 급여진료분류 == "통원" else 급여
        급여설명 = f"✅ 급여 ({급여진료분류}): {급여:,} – 5,000 = {급여보상:,}원"
    else:
        급여보상 = max(0, 급여 - 급여공제)
        공제율 = round(급여공제 / 급여 * 100, 1) if 급여 > 0 else 0
        급여설명 = f"✅ 급여: {급여:,} – 공제 {급여공제:,} = {급여보상:,}원 (공제율 {공제율}%)"

    비급여보상 = 0

    # ✅ 3대 비급여 항목 처리 (보장비율 없이 공제만)
    for 항목명, 금액 in zip(["도수치료", "주사", "MRI"], [도수, 주사, mri]):
        if 금액 == 0:
            continue
        if 면책여부.get(항목명, False):
            설명목록.append(f"❌ {항목명}: 약관상 면책")
            continue
        공제, 퍼센트 = 공제계산(금액, 특약비공제)
        보상금 = max(0, 금액 - 공제)
        설명목록.append(f"🔹 {항목명} | 공제 {int(공제):,}원 ({퍼센트}%) 차감 → 보상 {int(보상금):,}원")
        비급여보상 += 보상금

    # ✅ 일반 비급여 처리 (공제만 적용)
    if 일반비급여 > 0:
        공제, 퍼센트 = 공제계산(일반비급여, 일반비공제)
        보상금 = max(0, 일반비급여 - 공제)
        설명목록.append(f"🔹 일반 비급여 | 공제 {int(공제):,}원 ({퍼센트}%) 차감 → 보상 {int(보상금):,}원")
        비급여보상 += 보상금

    총보상 = 급여보상 + 비급여보상
    return 급여보상, 비급여보상, 총보상, 설명목록, 급여설명


# ✅ Streamlit UI
st.set_page_config(page_title="실손보험 계산기", layout="centered")
st.title("🧮 실손보험 계산기")
st.caption("⚠️ 실제 보상 결과는 보험사 심사 및 약관에 따라 달라질 수 있습니다. 반드시 담당자와 확인하시기 바랍니다.")

세대 = st.selectbox("실손보험 세대", ["1세대", "2세대", "3세대", "4세대"])
병원급 = st.radio("병원 등급", ["의원", "병원", "상급종합"])
급여 = st.number_input("급여 본인부담금", min_value=0, step=1000)
급여진료분류 = st.radio("급여 진료 분류", ["입원", "통원"])

st.markdown("### 🩺 비급여 입력")
총비급여 = st.number_input("총 비급여 본인부담금", min_value=0, step=1000)
col1, col2, col3 = st.columns(3)
with col1:
    도수 = st.number_input("도수치료", min_value=0, step=1000)
    도수면책 = st.checkbox("도수 면책", value=False)
with col2:
    주사 = st.number_input("주사", min_value=0, step=1000)
    주사면책 = st.checkbox("주사 면책", value=False)
with col3:
    MRI = st.number_input("MRI", min_value=0, step=1000)
    MRI면책 = st.checkbox("MRI 면책", value=False)

일반비급여 = max(0, 총비급여 - 도수 - 주사 - MRI)
st.info(f"📌 일반 비급여 자동 계산: {일반비급여:,}원")

if st.button("📊 계산하기"):
    면책 = {"도수치료": 도수면책, "주사": 주사면책, "MRI": MRI면책}
    급여보상, 비급여보상, 총보상, 설명리스트, 급여설명 = 실손_계산기(
        세대, 병원급, 급여, 급여진료분류, 일반비급여, 도수, 주사, MRI, 면책
    )

    st.subheader("💰 계산 결과")
    st.success(f"1️⃣ 급여 보상: {급여보상:,}원")
    st.success(f"2️⃣ 비급여 보상: {비급여보상:,}원")
    st.info(f"💵 총 보상금: {총보상:,}원")

    st.markdown("---")
    st.markdown("### 📘 급여 계산 설명")
    st.write(급여설명)

    st.markdown("### 📌 비급여 계산 상세 설명")
    for 설명 in 설명리스트:
        st.write(설명)

# ✅ 세대별 보장 범위 및 한도 (텍스트형)
st.markdown("---")
with st.expander("📋 세대별 보장 범위 및 한도"):
    st.markdown("""
#### 🧾 1세대 (2009년 이전)
- 급여·비급여 통합 보장
- 입원: 최대 5천만 원 한도
- 통원: 외래 1회 5,000원 공제 후 전액
- 약제비: 별도 한도 없음, 통합 보장
- 3대 비급여: 제한 없음

#### 🧾 2세대 (2009~2017)
- 급여·비급여 분리 보장
- 입원: 급여·비급여 각 5천만 원 한도
- 통원: 외래+약제비 합산 1회당 10~20% 또는 정액 공제
- 약제비: 1회 20만 원 이내, 연 90회
- 3대 비급여: 제한 없음 (심사 기준에 따라 일부 제한)

#### 🧾 3세대 (2018~2020)
- 급여: 90%, 비급여: 80%
- 통원: 1일 최대 20만 원
- 약제비: 연 100회, 특약 포함 시 보장
- 도수/주사/MRI: 1회당 30% 공제, 연간 총 50회 / 350만 원

#### 🧾 4세대 (2021~현재)
- 급여: 80%, 비급여: 70% (3대 특약 필수)
- 통원: 외래+약제비 합산, 1회당 3만 원 or 30% 공제
- 약제비: 연 100회 제한
- 3대 비급여: 특약 필수, 연 50회 / 350만 원, 1회당 30% 공제
""")
